// scripts/apply-blueprint.mjs
import { execa } from 'execa';
import fs from 'fs/promises';

async function generateReport(issueNumber, operations, diff = null, error = null) {
  let report = `## Blueprint Agent Report: #${issueNumber}\n\n`;
  if (error) {
    report += `**STATUS: FAILED** ðŸ”´\n\n`;
    report += `**ERROR:**\n\`\`\`\n${error.stack || error.message}\n\`\`\`\n`;
  } else {
    report += `**STATUS: SUCCESS** ðŸŸ¢\n\n`;
    report += `**Applied Changes:**\n`;
    if (operations.length > 0) {
      operations.forEach(op => {
        report += `- [x] Wrote ${op.content.length} bytes to \`${op.path}\`\n`;
      });
    } else {
      report += `- No file operations were specified.\n`;
    }
    if (diff) {
      const diffLimit = 8000;
      if (diff.length > diffLimit) {
        diff = diff.substring(0, diffLimit) + "\n\n... (diff truncated)";
      }
      report += `\n**Code Diff:**\n\`\`\`diff\n${diff}\n\`\`\`\n`;
    }
  }
  report += `\n---\n*This report was auto-generated by the Blueprint Agent.*`;
  return report;
}

async function main() {
  console.log('ðŸ”µ Blueprint Agent: Activated. Searching for new blueprints...');

  let issueNumber;
  const operations = [];

  try {
    const { stdout: issueJson } = await execa('gh', [
      'issue', 'list', '--state', 'open', '--limit', '1', '--json', 'number,body'
    ]);

    if (!issueJson || issueJson.trim() === '[]') {
      console.log('ðŸŸ¢ No new blueprints found. Standing by.');
      return;
    }

    const [issue] = JSON.parse(issueJson);
    issueNumber = issue.number;
    const { body } = issue;

    console.log(`ðŸ”µ Found Blueprint #${issueNumber}. Preparing to build...`);

    const fileRegex = /--- START OF FILE (.*?) ---\n([\s\S]*?)\n--- END OF FILE ---/g;
    let match;

    while ((match = fileRegex.exec(body)) !== null) {
      const filePath = match[1].trim();
      const fileContent = match[2];
      operations.push({ path: filePath, content: fileContent });
    }

    if (operations.length === 0) {
      // ... (empty blueprint handling)
      return;
    }

    for (const op of operations) {
      console.log(`- Writing to ${op.path}...`);
      await fs.writeFile(op.path, op.content, 'utf-8');
    }

    console.log('âœ… Build complete according to blueprint.');
    
    console.log('ðŸ”µ Staging changes and generating diff report...');
    await execa('git', ['add', '.']);
    
    // **[CRITICAL FIX]** Ensure diff is captured correctly.
    const { stdout: diff } = await execa('git', ['diff', '--staged']);

    await execa('git', ['commit', '-m', `feat: Apply blueprint from Issue #${issueNumber}`]);
    await execa('git', ['push']);

    const report = await generateReport(issueNumber, operations, diff);
    await execa('gh', ['issue', 'comment', issueNumber.toString(), '--body', report]);
    await execa('gh', ['issue', 'close', issueNumber.toString()]);

    console.log(`ðŸŸ¢ Blueprint #${issueNumber} applied and closed. Report with diff posted.`);

  } catch (error) {
    console.error('ðŸ”´ An error occurred in the Blueprint Agent:', error);
    if (issueNumber) {
      const report = await generateReport(issueNumber, null, null, error);
      await execa('gh', ['issue', 'comment', issueNumber.toString(), '--body', report]);
    }
    process.exit(1);
  }
}

main();