// scripts/apply-blueprint.mjs (PR Workflow Version)

import { execa } from 'execa';
import fs from 'fs/promises';

// Bug 1 Fix: Use environment variable instead of hardcoded webhook URL
// If not set, Echo Protocol is disabled (graceful degradation)
const ECHO_WEBHOOK_URL = process.env.ECHO_WEBHOOK_URL || null;

async function sendEcho(report) {
  if (!ECHO_WEBHOOK_URL) {
    console.log('ðŸŸ¡ Echo Protocol: Webhook URL not configured. Skipping echo transmission.');
    return;
  }
  
  try {
    console.log('ðŸ”µ Echo Protocol: Transmitting report to Architect...');
    await fetch(ECHO_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ report }),
    });
    console.log('ðŸŸ¢ Echo sent successfully.');
  } catch (error) {
    console.error('ðŸ”´ Echo Protocol: Failed to send report.', error);
  }
}

async function generateReport(issueNumber, operations, prURL = null, error = null) {
  let report = `## Blueprint Agent Report: #${issueNumber}\n\n`;
  if (error) {
    report += `**STATUS: FAILED** ðŸ”´\n\n**ERROR:**\n\`\`\`\n${error.stack || error.message}\n\`\`\`\n`;
  } else {
    report += `**STATUS: PULL REQUEST CREATED** ðŸŸ¢\n\n`;
    report += `A Pull Request has been created for your review. The Guardian Protocol is now running checks.\n\n`;
    // Bug 3 Fix: Trim the prURL to remove trailing whitespace/newlines
    if (prURL) {
      report += `**[âž¡ï¸ Review Pull Request](${prURL.trim()})**\n\n`;
    }
    report += `**Applied Changes:**\n`;
    operations.forEach(op => {
      report += `- [x] Wrote ${op.content.length} bytes to \`${op.path}\`\n`;
    });
  }
  report += `\n---\n*This report was auto-generated by the Blueprint Agent.*`;
  return report;
}

async function main() {
  console.log('ðŸ”µ Blueprint Agent: Activated. Searching for new blueprints...');
  let issueNumber;
  const operations = [];
  let report;

  try {
    const { stdout: issueJson } = await execa('gh', ['issue', 'list', '--state', 'open', '--limit', '1', '--json', 'number,body,title']);
    if (!issueJson || issueJson.trim() === '[]') {
      console.log('ðŸŸ¢ No new blueprints found. Standing by.');
      return;
    }
    const [issue] = JSON.parse(issueJson);
    issueNumber = issue.number;
    const { body, title } = issue;
    console.log(`ðŸ”µ Found Blueprint #${issueNumber}. Preparing to build...`);

    const branchName = `blueprint/issue-${issueNumber}`;
    await execa('git', ['checkout', '-b', branchName]);

    const fileRegex = /--- START OF FILE (.*?) ---\n([\s\S]*?)\n--- END OF FILE ---/g;
    let match;
    while ((match = fileRegex.exec(body)) !== null) {
      operations.push({ path: match[1].trim(), content: match[2] });
    }

    // Bug 2 Fix: Check for empty blueprints before proceeding
    if (operations.length === 0) {
      console.log('ðŸŸ¡ Blueprint is empty or malformed. Closing issue and standing by.');
      report = await generateReport(issueNumber, operations);
      await execa('gh', ['issue', 'comment', issueNumber.toString(), '--body', report]);
      await execa('gh', ['issue', 'close', issueNumber.toString()]);
      await execa('git', ['checkout', 'main']);
      return;
    }

    for (const op of operations) {
      console.log(`- Writing to ${op.path}...`);
      await fs.writeFile(op.path, op.content, 'utf-8');
    }
    console.log('âœ… Build complete.');

    await execa('git', ['add', '.']);
    await execa('git', ['commit', '-m', `feat: Apply blueprint from Issue #${issueNumber}\n\nCloses #${issueNumber}`]);
    await execa('git', ['push', '-u', 'origin', branchName]);

    // Bug 3 Fix: Trim the prURL output to remove trailing whitespace/newlines
    const { stdout: prURL } = await execa('gh', ['pr', 'create', '--title', title, '--body', `Auto-created PR for Issue #${issueNumber}.`, '--base', 'main', '--head', branchName]);
    
    report = await generateReport(issueNumber, operations, prURL.trim());
    await execa('gh', ['issue', 'comment', issueNumber.toString(), '--body', report]);
    await sendEcho(report);

    console.log(`ðŸŸ¢ Pull Request created for Blueprint #${issueNumber}.`);
    await execa('git', ['checkout', 'main']);

  } catch (error) {
    console.error('ðŸ”´ Agent Error:', error);
    if (issueNumber) {
      report = await generateReport(issueNumber, null, null, error);
      await execa('gh', ['issue', 'comment', issueNumber.toString(), '--body', report]);
      await sendEcho(report);
    }
    try { await execa('git', ['checkout', 'main']); } catch (e) {}
    process.exit(1);
  }
}

main();
